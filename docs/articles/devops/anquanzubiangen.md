#一次突然出现的线上故障，最后复盘原因竟是

## 问题描述
在一个风和日丽的下午，我正在逛着论坛，突然收到线上服务批量离线的报错，这可是用户使用最多的服务，估计马上投诉就过来了，得马上处理。

## 问题排查
1. 首先我查看了服务的日志，发现服务连不上数据库了，但是和开发同步之后发现近期并没有更改数据库的配置，这让我很奇怪。
2. 检查数据库的连接地址，发现也是正确的，是内网地址，没有问题。
3. 本地使用navicat连接数据库，发现也是可以连接的，这让我很奇怪。
4. 我在云上的服务器启动了一个mysql的容器，进入容器内部，使用mysql命令连接数据库，发现无法连接的。
5. 这时候我再去检查数据库的安全组设置，发现安全组设置的不对，安全组设置的是172.16.0.0/24，我们的VPC的网段是172.16.0.0/16，所以导致数据库连接失败。
6. 先修改安全组到正确的设置，恢复服务要紧，再排查问题。
7. 回到安全组的问题，之前这个安全组是由开发创建，因为网络知识不扎实，配错了掩码，导致这个安全组设置的不对，但是当时为什么服务可以连接上数据库。
8. 首先阿里云的存在多个安全组的时候，他的安全组规则是按照并集来计算的，我再去检查了数据的安全组，一共有三个，第一个就是VPC的安全组，里面只有一个172.16.0.0/24， 第二个安全组则是公司的公网出口，也就两个公网ip，也没有问题，还有一个安全组是阿里云DTS服务创建的安全组，但我们无法修改这个安全组。
9. 最后我们提交了工单，查看了DTS安全组的变更记录，发现DTS的安全组之前存在大网段的地址段 比如172.16.0.0/16 192.168.0.0/16，这也就是为什么我们之前配错了安全组，我们的ECS还是可以连接到数据库，然后阿里云在下午的时候进行了一次变更，删除了这些大网段的地址，就导致了我们的服务连不上数据库，最后产生线上故障。
    


## 问题总结

 <span style="font-size: 1.5em; font-weight: bold;">1. 不能相信开发的网络水平，还是得让运维去配置，检查。</span>

2. 安全组的规则是按照并集来计算的，所以要注意安全组的规则。
3. 注意阿里云的服务变更对业务本身带来的影响。
